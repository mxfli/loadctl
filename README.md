# loadctl - 负载控制工具

## 概述

loadctl 是一个安全可靠的系统资源压力测试工具套件，用于替代可能导致系统重启的原始脚本。使用专业的 `stress-ng` 工具渐进式控制算法，实现安全的 CPU
和内存压力测试。

## 主要特性

✅ **安全可靠**: 使用 `stress-ng` 专业工具，避免系统崩溃风险  
✅ **智能调节**: 实时监控并自动调整资源使用，保持在安全范围内  
✅ **基线内存追踪**: 动态跟踪系统基线内存，确保只控制增量负载  
✅ **渐进启动**: 分步骤逐渐增加负载，避免系统冲击  
✅ **自动保护**: 多重安全检查，保护现有运行程序  
✅ **实时监控**: 提供详细的系统状态监控界面  
✅ **优雅退出**: 完善的资源清理机制  
✅ **快速部署**: 支持分发包方式，便于多服务器快速部署

## 文件说明

| 文件名                    | 用途             | 说明                 |
|------------------------|----------------|--------------------|
| `loadctl.sh`           | 主控制脚本          | 智能资源控制和压力测试        |
| `system_monitor.sh`    | 监控脚本           | 实时系统状态监控           |
| `install_and_setup.sh` | 安装脚本           | 自动安装依赖和设置环境        |
| `install_stress_ng.sh` | stress-ng 安装脚本 | 统一安装脚本，支持在线/离线模式   |
| `emergency_cleanup.sh` | 紧急清理脚本         | 清理残留的 stress-ng 进程 |
| `README.md`            | 总览文档           | 项目概述和快速开始          |

## 快速开始

### 1. 一键安装和设置

```bash
./install_and_setup.sh
```

### 2. 编译安装 stress-ng（可选）

```bash
# 在线模式：从 GitHub 下载并安装
./install_stress_ng.sh --offline false

#wget https://github.com/ColinIanKing/stress-ng/archive/refs/tags/V0.19.05.tar.gz
# 离线模式：使用本地源代码包（默认）,需要自己从 stress-ng 下载源代码包，放在与脚本相同目录
./install_stress_ng.sh
```

### 3. 运行示例选择器

```bash
./quick_start_examples.sh
```

### 4. 基本使用

```bash
# 测试模式 - 检查参数但不实际运行
./loadctl.sh -T

# 轻度压力测试 - CPU 35%, 内存 40%, 运行 5 分钟
./loadctl.sh -t 300 -c 35 -m 40

# 标准压力测试 - CPU 50%, 内存 50%, 运行 15 分钟
./loadctl.sh

# 实时监控 (在另一个终端)
./system_monitor.sh
```

## 详细使用说明

### 主控制脚本参数

```bash
./loadctl.sh [选项]

选项:
  -t <秒数>     运行时间 (默认: 900秒)
  -c <百分比>   目标CPU使用率 (默认: 50%, 范围: 35-65%)
  -m <百分比>   目标内存使用率 (默认: 50%, 范围: 35-65%)
  -i <秒数>     监控调整间隔 (默认: 10秒)
  -s <步骤数>   渐进启动步骤 (默认: 5步)
  -l <文件>     日志文件路径
  -T            测试模式，只显示配置不实际运行
  -h            显示帮助信息
```

### 监控脚本参数

```bash
./system_monitor.sh [选项]

选项:
  -i <秒数>    刷新间隔 (默认: 2秒)
  -l <文件>    日志文件路径
  -1           只运行一次，不持续监控
  -h           显示帮助信息
```

## 核心功能详解

### 基线内存追踪（Baseline Memory Tracking）

loadctl.sh 的一基本功能是**动态基线内存追踪**，确保压力测试只消耗增量内存，不影响系统原有负载。

**工作原理：**

1. **启动前测量基线**：在启动 stress-ng 前，记录系统当前内存使用率（例如 12%）
2. **计算增量分配**：如果目标是 40%，则 stress-ng 只分配 28%（40% - 12%）
3. **动态调整基线**：持续监控系统其他进程的内存变化
    - 如果其他应用增加内存使用（基线从 12% → 20%）
    - 自动减少 stress-ng 分配（从 28% → 20%）
    - 保持总内存使用率在目标值 40%

**优势：**

- ✅ 精确控制：确保系统总内存使用率等于目标值，而不是超过
- ✅ 保护业务：不会挤占业务应用的内存空间
- ✅ 适应变化：自动适应生产环境中其他应用的内存波动
- ✅ 真实模拟：更准确地模拟特定负载水平

**示例场景：**

```bash
# 目标：系统总内存达到 40%
./loadctl.sh -t 900 -c 45 -m 40

# 日志示例：
# [2025-10-21 14:29:20] 基线内存使用率: 12%
# [2025-10-21 14:29:20] stress-ng 分配: 28% (40% - 12%)
# [2025-10-21 14:30:15] 监控: CPU 47%, 内存 40%, 基线 12%
# [2025-10-21 14:31:20] 基线内存变化: 12% -> 15% (其他应用增加)
# [2025-10-21 14:31:20] stress-ng 重新分配: 25% (40% - 15%)
```

## 使用场景

### 1. 系统压力测试

测试系统在不同负载下的表现和稳定性：

```bash
# 轻度压力测试
./loadctl.sh -t 600 -c 35 -m 40

# 中度压力测试  
./loadctl.sh -t 1800 -c 50 -m 50

# 高强度压力测试
./loadctl.sh -t 3600 -c 60 -m 55
```

### 2. 性能基线测试

建立系统性能基线，用于容量规划：

```bash
# 长时间稳定性测试
./loadctl.sh -t 14400 -c 45 -m 45 -i 15
```

### 3. 监控和调试

实时监控系统状态：

```bash
# 持续监控
./system_monitor.sh

# 一次性检查
./system_monitor.sh -1

# 自定义刷新间隔
./system_monitor.sh -i 5
```

## 安全保障

### 自动保护机制

1. **运行前检查**: CPU、内存、负载状态检查，确保系统适合运行测试
2. **基线内存追踪**: 动态监控并保护系统基线内存，只控制增量负载
3. **渐进式启动**: 分步骤逐渐增加资源使用（默认5步），避免系统冲击
4. **实时监控**: 持续监控CPU、内存、系统负载，每10秒调整一次
5. **安全边界**: 严格限制在35-65%范围内，防止系统过载
6. **智能调节**: 过载时自动减少资源消耗，差距超过10%时才调整
7. **目标上限保护**: 动态调整永不超过用户指定的原始目标值
8. **优雅退出**: 完善的信号处理和资源清理，多重进程清理机制

### 系统要求

- Linux 系统 (推荐 Ubuntu 18.04+ 或 CentOS 7+)
- 至少 2GB 内存
- stress-ng 工具
- bc 计算器
- 普通用户权限即可运行

## 故障排除

### 常见问题

1. **stress-ng 未找到**
   ```bash
   # 运行安装脚本
   ./install_and_setup.sh
   ```

2. **权限问题**
   ```bash
   chmod +x *.sh
   ```

3. **系统负载过高**
   ```bash
   # 检查当前状态
   ./system_monitor.sh -1
   # 等待负载降低后再运行
   ```

### 紧急停止

```bash
# 正常停止
Ctrl+C

# 如果脚本结束但进程仍在运行，使用紧急清理脚本
./emergency_cleanup.sh

# 强制清理（不询问确认）
./emergency_cleanup.sh -f

# 手动清理命令
pkill -f stress-ng
pkill -f loadctl

# 如果上述命令无效，使用强制终止
sudo pkill -9 -f stress-ng
```

## 最佳实践

1. **生产环境使用前**
    - 先在测试环境充分验证
    - 从较低的目标值开始 (35%-40%)
    - 设置较短的运行时间进行测试

2. **监控关键指标**
    - 同时运行监控脚本观察系统状态
    - 关注业务应用的响应时间
    - 监控系统日志和告警

3. **容量规划**
    - 记录不同负载下的系统表现
    - 建立性能基线和告警阈值
    - 制定扩容和优化策略

## 技术支持

如果遇到问题请参考一下内容：

1. 检查日志文件: `/tmp/loadctl.log`
2. 运行系统检查: `./system_monitor.sh -1`
3. 使用测试模式: `./loadctl.sh -T`

## 部署最佳实践

### 生产环境建议

1. **首次部署**
    - 在测试环境充分验证后再部署到生产
    - 使用较低的目标值开始（CPU 35%，内存 35%）
    - 先运行短时间测试（5-10分钟）

2. **定时任务配置**
   ```bash
   # 建议在业务低峰期运行（如凌晨2-4点）
   0 2 * * * /opt/app/loadctl/loadctl.sh -t 900 -c 45 -m 40 >/dev/null 2>&1
   ```

3. **监控和告警**
    - 配合业务监控系统使用
    - 关注业务应用的响应时间
    - 设置负载告警阈值

## 许可

- 本项目脚本与文档采用 `MIT License`（详见下文“版本信息”）。
- 项目仅调用系统已安装的 `stress-ng`；不随项目分发其二进制或源码，通常无需附带 GPL 文本或改变本项目许可。
- 如未来需要随项目分发 `stress-ng`，请参考上游许可（GPL-2.0）。

## 版本信息

### 版本更新记录

**v0.1.0 (2025-10-21)**

- 基础智能资源控制功能 ,渐进式启动和实时监控 , 多种安装方式支持
- ✨ 新增基线内存追踪功能，精确控制增量内存使用
- 🚀 新增分发包部署方式，支持快速多服务器部署
- 🔧 改进为动态编译，减小文件体积并自动管理依赖
- 📦 install_and_setup.sh 支持自动检测并优先使用 dist 包
- 🛡️ 增强安全保护机制，添加目标上限保护
- 📝 完善文档，新增核心功能详解和部署最佳实践

---

**注意**: 此工具套件专门设计用于替代可能导致系统重启的shel脚本版本，提供更安全、更可靠的系统压力测试解决方案，请谨慎在生产环境使用，做好重分测试。